# diary@20221113

## [éƒ‘å·æŸ“ç–«å®¶åº­è®°å½•](https://chinadigitaltimes.net/chinese/689664.html)
_tags: #covid_

> æ™šä¸Šï¼Œç¤¾åŒºå¿—æ„¿è€…é€šçŸ¥è€ƒè™‘åˆ°å®é™…æƒ…å†µï¼Œå¯ä»¥å°†æˆ‘å®¶é‡Œçš„ä¸‰äººä¸€èµ·è½¬ç§»åˆ°éš”ç¦»é…’åº—ï¼Œé…’åº—æˆ¿é—´æœ‰é™ï¼Œ
>   éœ€è¦å°½å¿«ç­”å¤å»ä¸å»ï¼Œå»ºè®®åŒæ„è½¬ç§»ï¼Œå¦åˆ™æ˜å¤©å¯èƒ½è¦å¼ºåˆ¶è½¬ç§»ã€‚
>   æˆ‘å’Œè€å©†ç¢ç£¨å®¶é‡Œå·²ç»æ²¡ä¸œè¥¿åƒï¼Œä¸”æ²¡æœ‰äººæ„¿æ„å¸®å¿™é€ä¸Šæ¥ï¼Œå†µä¸”å®¶é‡Œåˆ°å¤„æ˜¯ç—…æ¯’ï¼Œåº”è¯¥è¿˜ä¸å¦‚é…’åº—ã€‚
>   æˆ‘ä»¬é©¬ä¸Šå›ç”µè¯åŒæ„è½¬ç§»ã€‚
>
> 11æœˆ5æ—¥ï¼Œå‡Œæ™¨4ç‚¹ï¼Œç¤¾åŒºå¿—æ„¿è€…é€šçŸ¥æˆ‘ä»¬ä¸‹æ¥¼å‡†å¤‡è½¬ç§»ã€‚
>   è½¦ä¸Šç­‰äº†1ä¸ªå°æ—¶ï¼Œå¼€åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼Œåˆç­‰1ä¸ªå°æ—¶ï¼Œå†åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œåˆç­‰1ä¸ªå°æ—¶ï¼Œ
>   å¤§æ¦‚8ã€9ç‚¹é’Ÿï¼Œå¤§å·´å¼€è¿›äº†éƒ‘æ±´è·¯çš„ä¸­åŸå›½é™…åšè§ˆä¸­å¿ƒï¼Œä¸æ˜¯é…’åº—ã€‚
>   æˆ‘è€å©†åˆå´©æºƒäº†ã€‚å¥¹ä¸€æ¬¡åˆä¸€æ¬¡æ‰“ç”µè¯ç»™ç¤¾åŒºå‰å‰ååé€šçŸ¥è½¬ç§»çš„äººè´¨é—®ä¸ºä»€ä¹ˆéª—äººï¼Œä½†é€šé€šå…³æœºã€‚

> æˆ‘æƒ³é—®éƒ‘å·å¸‚æ”¿åºœï¼š
> 1. ä¸ºä»€ä¹ˆä¸åŠæ—¶è½¬è¿ç¡®è¯Šç—…ä¾‹ï¼Œå®³å¾—ä¸€æ ‹æ¥¼ä¼¼ä¹ä¸€åŠçš„äººéƒ½æ„ŸæŸ“ï¼Ÿ
> 2. ä¸ºä»€ä¹ˆç¡®è¯Šæƒ…å†µä¸å…¬å¸ƒï¼Œå¸‚æ°‘å¯¹å…³ä¹è‡ªå·±ç”Ÿå‘½å¥åº·çš„ä¿¡æ¯ä¸€æ— æ‰€çŸ¥ï¼Œåªèƒ½ä»»ç”±æ‘†å¸ƒï¼Ÿ
> 3. ä¸ºä»€ä¹ˆè®©å°å­©è·Ÿçˆ¶æ¯å›¢èšè¿™ä¹ˆéš¾ï¼Ÿæˆ‘çš„éœ€æ±‚å¤ªè¿‡ç‰¹æ®Šï¼Ÿ
> 4. ä¸ºä»€ä¹ˆæ ¸é…¸æ£€æµ‹ç»“æœä¸å‡†ç¡®åé¦ˆï¼Œåˆ°ç°åœ¨æˆ‘åœ¨éƒ‘å¥½åŠä¸Šéƒ½çœ‹ä¸åˆ°é˜³æ€§è®°å½•ï¼Œå¥åº·ç è¿˜æ˜¯ç»¿ç ï¼Ÿ
> 5. ä¸ºä»€ä¹ˆå¯¹å¸‚æ°‘è¿å“„å¸¦éª—ï¼Œè¯¥æ€ä¹ˆç›¸ä¿¡ä½ ï¼Ÿ
> 6. ä¸ºä»€ä¹ˆèŠ±ä¸€ä¸ªå°æ—¶æ‰“é€š12345ä¹Ÿåªæ˜¯åé¦ˆæœ‰å…³å•ä½ç„¶åä¸äº†äº†ä¹‹ï¼Œè°æ˜¯ç›¸å…³å•ä½ï¼Ÿ
> 7. å¦‚æœæŠ—ç–«æŒ‡æŒ¥éƒ¨æ˜¯ç›¸å…³éƒ¨é—¨ï¼Œä¸ºä»€ä¹ˆç”µè¯å¯ä»¥æ˜¯ç©ºå·ï¼Ÿæˆ–è€…æ°¸è¿œæ²¡äººæ¥å¬ï¼Ÿ
> 8. ä¸ºä»€ä¹ˆæˆ‘èƒ½æ¥è§¦åˆ°çš„æ‰€æœ‰éƒ¨é—¨éƒ½å£°ç§°è‡ªå·±åªæ˜¯å¥‰å‘½æ“ä½œï¼Œä¸è´Ÿè´£è‡ªå·±æ­£åœ¨åšå·¥ä½œï¼Ÿåˆ°åº•è°è´Ÿè´£ï¼Ÿ
>     è¿™èƒŒåçš„å·¥ä½œæœºåˆ¶åˆ°åº•æ˜¯æ€æ ·çš„ï¼Ÿ
> 9. ä¸ºä»€ä¹ˆä¿¡æ¯å¤šå¤´ï¼Œç–¾æ§ä¸­å¿ƒä¸€éåˆä¸€éäº†è§£æƒ…å†µï¼Œå´è¯´ä¸æ¸…æ¥šï¼Œæ··ä¹±åˆ°æˆ‘è‡ªå·±æ˜¯ä»€ä¹ˆæƒ…å†µéƒ½æ²¡åŠæ³•æŒæ¡ï¼Ÿ

å¯å‘ï¼š
- å¦‚æœå®¶é‡Œæœ‰äººé˜³äº†ï¼Œå¤§æ¦‚ç‡å…¨å®¶éƒ½ä¼šé˜³ï¼Œä¸»åŠ¨éš”ç¦»æ„ä¹‰ä¸å¤§ï¼Œæå‰åšå¥½å…¨å®¶è½¬ç§»çš„å‡†å¤‡å§ã€‚
- ä¸è¦è½»ä¿¡ã€Œè½¬ç§»åˆ°éš”ç¦»é…’åº—ã€çš„è®¸è¯ºï¼Œå¦‚æœé€‰æ‹©è½¬ç§»ï¼Œå°±è¦ä¸ºè¿›æ–¹èˆ±å‡†å¤‡å‘¨å…¨ã€‚
- å…¨å®¶ä¸€èµ·è½¬ç§»ï¼Œå¦åˆ™å®æ­»ä¸å‡ºé—¨ã€‚
- ã€Œç›¸å…³éƒ¨é—¨ã€æ²¡åæ²¡å§“æ²¡è´£ä»»äººã€‚æ²¡æœ‰ç¬¬ä¸‰æ–¹ç›‘ç£æƒ…å†µä¸‹è‚†æ„å¦„ä¸ºã€‚éš¾é“è¦å¾®åšç›´æ’­æŠ—å½¹å…¨è¿‡ç¨‹ï¼Ÿ

## GitHub Codespaces åˆä½“éªŒ

- 2C4G çš„è™šæ‹Ÿæœºï¼Œ Ubuntu 18 ç³»ç»Ÿï¼Œå½“ä¸ªå…è´¹çš„ä¸´æ—¶æœåŠ¡å™¨ç”¨ç”¨å¾ˆä¸é”™äº†ã€‚
- é¢„è£…äº† gitã€sdkmanã€javaã€nodeã€mvnã€yarn ç­‰å·¥å…·ï¼Œå¼€ç®±å³ç”¨ã€‚
- `sudo apt install` çš„è½¯ä»¶ï¼Œæ–­å¼€é‡è¿åä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œä¼šè¿‡æœŸä¸ï¼Ÿ
- é¦–æ¬¡æ‰“å¼€æ—¶ï¼Œvscode çš„ markdown é¢„è§ˆåŠŸèƒ½å’Œ git é¢æ¿ä¸è¡Œç”¨ï¼Œé‡è¿ååˆå¥½äº†ã€‚
- ç½‘ç»œæœ‰ç‚¹å„¿æ…¢ï¼Œå­—ç¬¦è¾“å…¥æœ‰å»¶è¿Ÿã€‚

## [HTTP æœåŠ¡æé™ä¼˜åŒ–è‡³ 1.2M rps](https://talawah.io/blog/extreme-http-performance-tuning-one-point-two-million/)
_tags: #optimization #kernal #concurrency_

- ä¼˜åŒ–æ•ˆæœï¼š 224k â†’ 1.2m rpsã€‚ç¡¬ä»¶é…ç½® aws 4 vCPU c5n.xlarge instance
- ä¸»è¦å·¥å…·ï¼š [Flame Graphs](https://www.brendangregg.com/flamegraphs.html)
- ä¼˜åŒ–æŠ€å·§
  1. åº”ç”¨å±‚ä¼˜åŒ– ï¼ˆ224k â†’ 347kï¼‰
     - Run on all vCPUs: 25-27%
     - Use gcc -O3 when building the framework: 5-10%
     - Use march=native when building the app: 5-10%
     - Use send/recv instead of write/read: 5-10%
     - Avoid pthread overhead: 2-3%
  1. ç³»ç»Ÿå†…æ ¸ speculative execution mitigations ï¼ˆ347k â†’ 446kï¼‰ // çœ‹ä¸å¤ªæ‡‚ ğŸ˜‚
  1. `docker run --security-opt seccomp=unconfined` ï¼ˆ446k â†’ 495kï¼‰
  1. Disabling iptables/netfilter ï¼ˆ495k â†’ 603kï¼‰
  1. perfect locality ï¼ˆ603k â†’ 834kï¼‰// çœ‹ä¸å¤ªæ‡‚ ğŸ˜‚
  1. Interrupt Optimizations ï¼ˆ834k â†’ 1.06Mï¼‰// çœ‹ä¸å¤ªæ‡‚ ğŸ˜‚
  1. Disabling dhclient ï¼ˆ1.06M â†’ 1.12Mï¼‰// çœ‹ä¸å¤ªæ‡‚ ğŸ˜‚
  1. Switching to noqueue ï¼ˆ1.12M â†’ 1.15Mï¼‰// æ‡µ ğŸ˜‚
  1. Disabling Generic Receive Offload + TCP Congestion Control + Static Interrupt Moderation ï¼ˆ1.15M â†’ 1.2Mï¼‰// æ‡µ ğŸ˜‚
- å°è¯•è¿‡çš„æ— æ•ˆä¼˜åŒ–
  - ä¸ä½¿ç”¨ docker è¿è¡ŒæœåŠ¡ç«¯
  - Using writev instead of send (slower)
  - å…¶å®ƒ gcc ç‰ˆæœ¬å’Œå…¶å®ƒç¼–è¯‘å‚æ•°
  - å‡çº§ Linux ç‰ˆæœ¬
  - è°ƒæ•´å„ç§å†…æ ¸å‚æ•°
  - å„ç§ç½‘ç»œé…ç½®
